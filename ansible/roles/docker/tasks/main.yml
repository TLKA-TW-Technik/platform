---
# Install and configure docker
- name: Add the Docker repository signing key (direct connection)
  apt_key: id=58118E89F3A912897C070ADBF76221572C52609D keyserver=hkp://p80.pool.sks-keyservers.net:80 state=present
  when: http_proxy is not defined
- name: Add the Docker repository signing key (via proxy server)
  command: apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --keyserver-options http-proxy="{{http_proxy}}" --recv-keys 36A1D7869245C8950F966E92D8576A8BA88D21E9
  when: http_proxy is defined
- name: Add the Docker repository
  apt_repository: repo='deb https://apt.dockerproject.org/repo ubuntu-trusty main' state=present

- name: Install Docker
  apt: pkg=docker-engine state=present
- name: Install pip
  apt: pkg=python-pip state=present
- name: Install docker-py
  pip: name=docker-py version=1.0.0
- name: Add user 'teamwire' to the docker group
  user: name=teamwire groups=docker append=yes

- name: Configure proxy for docker
  when: http_proxy is defined
  lineinfile: dest=/etc/default/docker regexp=http_proxy line='export http_proxy="{{http_proxy}}"'
  notify: restart docker

# Make sure docker is restarted before the containers are set up, otherwise
# the restart would kill the running containers. We need to restart before the
# following step, otherwise the login would fail when a proxy is configured.
- meta: flush_handlers

- name: Log in on Docker Hub
  command: docker login -e "{{ dockerhub_email }}" -u "{{ dockerhub_username }}" -p "{{ dockerhub_password }}"
  become: True
  become_user: teamwire
  when: config_done is defined
  args:
    creates: /home/teamwire/.docker/config.json

- name: Configure firewall to allow Docker containers access to the host
  ufw: rule=allow interface=docker0 direction=in

---
- name: Ensure private IP address in configured
  fail: msg="private_ip is not configured. Please check your hosts file"
  when: private_ip is not defined

- name: Ensure private IP address is valid
  fail: msg="Defined private_ip is not configured on the system. Please check your config."
  when: private_ip not in ansible_all_ipv4_addresses

- name: Add other cluster nodes to /etc/hosts
  lineinfile:
    dest: /etc/hosts
    line: "{{ hostvars[item]['private_ip'] }}\t{{ item }} "
  with_items: "{{ groups['all'] | default([]) }}"

- name: Allow all access from other cluster nodes
  ufw: rule=allow src="{{ hostvars[item]['private_ip'] }}"
  with_items: "{{ groups['all'] | default([]) }}"
  when: item != inventory_hostname

- name: Ensure rsyslog is installed
  apt: pkg=rsyslog

- name: Send all logs to loghost
  when: "'loghost' in groups"
  template:
    src: 30-remote-logging.conf.j2
    dest: /etc/rsyslog.d/30-remote-logging.conf
  notify:
    - restart rsyslog

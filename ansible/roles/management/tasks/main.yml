# Keep track of the plattform repository
- name: Install git
  apt: pkg=git state=present

- name: Check out the teamwire/platform git repository
  git:
    repo: https://github.com/teamwire/platform.git
    depth: 1
    dest: /home/teamwire/platform
    update: no
  notify: fix ownership of git checkout

- stat: path=/home/teamwire/platform/ansible/group_vars/all
  register: config_file

- name: Secure permissions of Ansible configuration file
  file:
    path: /home/teamwire/platform/ansible/group_vars/all
    state: file
    mode: 0600
    owner: teamwire
    group: teamwire
  when: config_file.stat.exists

# Delete platform on other hosts
- name: Remove platform from unrequired hosts
  file:
    state: absent
    path: /home/teamwire/platform/
  when: groups['all'] | length() > 1 and not inventory_hostname in groups['management_servers']

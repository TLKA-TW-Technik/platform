---
- name: Ensure mysql_root_password is configured before installing the Database
  fail: msg="MySQL root password is not defined. Please check the configuration file"
  when: config_done is defined and mysql_root_password is defined and mysql_root_password == None

- name: Check if installing a database cluster
  set_fact:
    galera_cluster: True
  when: '"database_servers" in groups and groups["database_servers"] | length > 1'

- name: Add MariaDB repo signing key (direct, cluster setups)
  apt_key: keyserver="hkp://keyserver.ubuntu.com:80" id="cbcb082a1bb943db"
  when: http_proxy is not defined and galera_cluster is defined

- name: Add MariaDB repo signing key (via proxy, cluster setups)
  command: apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --keyserver-options http-proxy="{{http_proxy}}" --recv-keys cbcb082a1bb943db
  when: http_proxy is defined and galera_cluster is defined

- name: Configure MariaDB repository (cluster setups)
  apt_repository: repo="deb http://mirror2.hs-esslingen.de/mariadb/repo/10.1/debian jessie main" state=present update_cache=yes
  when: galera_cluster is defined
  notify: apt-get update

- name: Install MariaDB
  apt: name={{item}} state=present
  with_items:
  - mariadb-server
  - mariadb-client
  - python-mysqldb
  - mytop
  register: mysql_initial_installation

# Unfortunately MariaDB cannot be configure to listen on multiple interfaces
- name: Configure MariaDB to listen on all interfaces
  action: lineinfile dest=/etc/mysql/my.cnf regexp="^bind-address\s*=\s*127.0.0.1" backrefs=yes line="bind-address=0.0.0.0"
  notify: restart MariaDB

- name: set utf8 as default
  copy: src=utf8.cnf dest=/etc/mysql/conf.d/utf8.cnf
  notify: restart MariaDB

- name: set UTC as default
  copy: src=timezone.cnf dest=/etc/mysql/conf.d/timezone.cnf
  notify: restart MariaDB

- name: log slow queries
  copy: src=slow_query_log.cnf dest=/etc/mysql/conf.d/slow_query_log.cnf
  notify: restart MariaDB

- name: Disable unsecure functionality
  copy: src=security.cnf dest=/etc/mysql/conf.d/security.cnf
  notify: restart MariaDB

- name: Start and enable MariaDB server
  service: name=mysql state=started enabled=yes

# Make sure MariaDB is restarted before the databse is created, otherwise
# the configured defaults are not used.
- meta: flush_handlers

- name: Set password for MariaDB root user
  mysql_user: name=root password="{{mysql_root_password}}"
  when: mysql_initial_installation.changed

- name: Set password for the other MariaDB root users
  mysql_user: name=root password="{{mysql_root_password}}" host="{{item}}" login_user=root login_password="{{mysql_root_password}}"
  when: mysql_root_password is defined and (galera_cluster is not defined or inventory_hostname == groups['database_servers'][0])
  with_items:
    - 127.0.0.1
    - ::1
    - "{{external_hostname|default()}}"

- name: Create Teamwire database
  mysql_db: name=teamwire state=present login_user=root login_password="{{mysql_root_password}}"
  when: galera_cluster is not defined or inventory_hostname == groups['database_servers'][0]

- name: Create Teamwire database user
  when: config_done is defined and (galera_cluster is not defined or inventory_hostname == groups['database_servers'][0])
  mysql_user: name=teamwire host=% password={{teamwire_db_password}} priv=teamwire.*:ALL state=present login_user=root login_password="{{mysql_root_password}}"

- include: cluster.yml
  when: galera_cluster is defined
